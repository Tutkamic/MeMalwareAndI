using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class FloorTile : MonoBehaviour, IWalkable
{
    [SerializeField] GameObject SelectImage;
    [SerializeField] GameObject SelectableImage;
    [SerializeField] PlayerRangeSO playerRange;
    [SerializeField] GameModeSO currentGameMode;
    [SerializeField] LayerMask layermask;
    [SerializeField] GameObject[] borderImages;
    PathFinding pathFinding;

    private Border border;

    private Vector3[] dir = {
        new Vector3(0,0,1),
        new Vector3(1,0,1),
        new Vector3(1,0,0),
        new Vector3(1,0,-1),
        new Vector3(0,0,-1),
        new Vector3(-1,0,-1),
        new Vector3(-1,0,0),
        new Vector3(-1,0,1)
    };

    private RaycastHit[] raycastHit = new RaycastHit[8];
    public bool Selectable { get; private set; }

    private void OnEnable()
    {
        MovementCharacter.StartMoving += ResetSelectable;
    }


    private void OnDisable()
    {
        MovementCharacter.StartMoving -= ResetSelectable;
    }

    void Awake()
    {
        pathFinding = FindObjectOfType<PathFinding>();
        SelectImage.SetActive(false);
        SelectableImage.SetActive(false);
        Selectable = false;
    }


    public void CheckForEdge()
    {
        for (int i = 0; i < 8; i++) 
            //raycastHit[i] = Physics.Raycast(transform.position, dir[i], 0.72f, layermask);
            Physics.Raycast(transform.position, dir[i], out raycastHit[i], 0.72f, layermask);

        FindBorder();
        SetBorders();
    }


    public void SelectableChange()
    {
        SelectableImage.SetActive(Selectable);
    }

    public void Select()
    {
        SelectImage.SetActive(true);
    }

    public void UnSelect()
    {
        SelectImage.SetActive(false);
    }
    

    public void CalculateIsSelectable(float charPosX, float charPosZ)
    {
        if (playerRange.Range < 10) return;

        int x = Mathf.RoundToInt(charPosX);
        int z = Mathf.RoundToInt(charPosZ);

        PathNode startNode = pathFinding.GetGridNode(x, z);
        PathNode endNode = pathFinding.GetGridNode((int)transform.position.x, (int)transform.position.z);

        int distanceCost = pathFinding.CalculateDistnceCost(startNode, endNode);

        if (distanceCost <= playerRange.Range &&
            pathFinding.CalculatePathCost(pathFinding.FindPath(startNode, endNode)) <= playerRange.Range)
            Selectable = true;
    }

    public float DistanceCostToPlayer(float x, float z)
    {
        Vector3 playerPos = new Vector3 (x, transform.position.y, z);
        return Vector3.Distance(transform.position, playerPos) * 9;
    }

    public void ResetSelectable()
    {
        Selectable = false;
        SelectableChange();
    }

    private void Update()
    {
        if (currentGameMode.GameMode == GameMode.EnemyTour ||
            currentGameMode.GameMode == GameMode.GameOver ||
            currentGameMode.GameMode == GameMode.Pause)
        {
            UnSelect();
            Selectable = false;
            SelectableChange();
        }

        if (currentGameMode.GameMode == GameMode.VirusSelection) UnSelect();
    }

    private void FindBorder()
    {
        if (raycastHit[(int)Direction.Up].collider != null && !raycastHit[(int)Direction.Up].collider.GetComponent<FloorTile>().Selectable)
        {
            if (raycastHit[(int)Direction.Down].collider != null && !raycastHit[(int)Direction.Down].collider.GetComponent<FloorTile>().Selectable)
            {
                if (raycastHit[(int)Direction.Right].collider != null && !raycastHit[(int)Direction.Right].collider.GetComponent<FloorTile>().Selectable) border = Border.UpDownRight;
                else if (raycastHit[(int)Direction.Left].collider != null && !raycastHit[(int)Direction.Left].collider.GetComponent<FloorTile>().Selectable) border = Border.UpDownLeft;
            }
            else if (raycastHit[(int)Direction.Right].collider != null && !raycastHit[(int)Direction.Right].collider.GetComponent<FloorTile>().Selectable)
            {
                if (raycastHit[(int)Direction.Left].collider != null && !raycastHit[(int)Direction.Left].collider.GetComponent<FloorTile>().Selectable) border = Border.UpRightLeft;
                else border = Border.UpRight;
            }
            else if (raycastHit[(int)Direction.Left].collider != null && !raycastHit[(int)Direction.Left].collider.GetComponent<FloorTile>().Selectable)
            {
                border = Border.UpLeft;
            }
            else border = Border.Up;
        }
        else if (raycastHit[(int)Direction.Down].collider != null && !raycastHit[(int)Direction.Down].collider.GetComponent<FloorTile>().Selectable)
        {
            if (raycastHit[(int)Direction.Right].collider != null && !raycastHit[(int)Direction.Right].collider.GetComponent<FloorTile>().Selectable)
            {
                if (raycastHit[(int)Direction.Left].collider != null && !raycastHit[(int)Direction.Left].collider.GetComponent<FloorTile>().Selectable) border = Border.DownRightLeft;
                else border = Border.DownRight;
            }
            else if (raycastHit[(int)Direction.Left].collider != null && !raycastHit[(int)Direction.Left].collider.GetComponent<FloorTile>().Selectable)
            {
                border = Border.DownLeft;
            }
            else border = Border.Down;
        }
        else if (raycastHit[(int)Direction.Right].collider != null && !raycastHit[(int)Direction.Right].collider.GetComponent<FloorTile>().Selectable) border = Border.Right;
        else if (raycastHit[(int)Direction.Left].collider != null && !raycastHit[(int)Direction.Left].collider.GetComponent<FloorTile>().Selectable) border = Border.Left;
        else if (raycastHit[(int)Direction.UpRight].collider != null && !raycastHit[(int)Direction.UpRight].collider.GetComponent<FloorTile>().Selectable ) border = Border.CornerUpRight;
        else if (raycastHit[(int)Direction.UpLeft].collider != null && !raycastHit[(int)Direction.UpLeft].collider.GetComponent<FloorTile>().Selectable) border = Border.CornerUpLeft;
        else if (raycastHit[(int)Direction.DownRight].collider != null && !raycastHit[(int)Direction.DownRight].collider.GetComponent<FloorTile>().Selectable) border = Border.CornerDownRight;
        else if (raycastHit[(int)Direction.DownLeft].collider != null && !raycastHit[(int)Direction.DownLeft].collider.GetComponent<FloorTile>().Selectable ) border = Border.CornerDownLeft;
        else border = Border.None;

    }
    private void SetBorders()
    {
        foreach (var item in borderImages)
        {
            item.SetActive(false);
        }
        borderImages[(int)border].SetActive(true);
    }
}
