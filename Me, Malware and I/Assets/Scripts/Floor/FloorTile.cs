using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using DG.Tweening;

public class FloorTile : MonoBehaviour, IWalkable
{
    [SerializeField] GameObject MouseOverImage;
    [SerializeField] GameObject SelectableImage;
    [SerializeField] PlayerRangeSO playerRange;
    [SerializeField] GameModeSO currentGameMode;
    [SerializeField] LayerMask layermask;
    [SerializeField] Sprite[] borderSprite;
    [SerializeField] SpriteRenderer selectableSprite;
    [SerializeField] Material selectMaterial;
    [SerializeField] Material availableToSelect_Off;
    [SerializeField] Material availableToSelect_On;
    [SerializeField] private Color _emissionPasiveColorValue;
    [SerializeField] private Color _emissionActiveColorValue;
    private float _intensity;
    private float availableTOSelect_intensity;
    PathFinding pathFinding;

    private IDoorsHandler doorsController;

    private Border border;

    private Vector3[] dir = {
        new Vector3(0,0,1),
        new Vector3(1,0,1),
        new Vector3(1,0,0),
        new Vector3(1,0,-1),
        new Vector3(0,0,-1),
        new Vector3(-1,0,-1),
        new Vector3(-1,0,0),
        new Vector3(-1,0,1)
    };

    private RaycastHit[] raycastHit = new RaycastHit[8];
    public bool Selectable { get; private set; }
    public bool DoorController { get; private set; }

    private void OnEnable()
    {
        GameModeHandler.StartMode += StartNewMode;
        MovementCharacter.StartMoving += ResetSelectable;
        InputCharacter.OnFLoorClicked += ResetDoorController;
    }


    private void OnDisable()
    {
        GameModeHandler.StartMode -= StartNewMode;
        MovementCharacter.StartMoving -= ResetSelectable;
        InputCharacter.OnFLoorClicked -= ResetDoorController;

    }

    void Awake()
    {
        pathFinding = FindObjectOfType<PathFinding>();
        MouseOverImage.SetActive(false);
        SelectableImage.SetActive(false);
        Selectable = false;
        ChangeAvailableToSelectMaterial();
    }

    private void StartNewMode(GameMode obj)
    {
        UnSelect();
        ChangeAvailableToSelectMaterial();
    }

    private void ChangeAvailableToSelectMaterial()
    {
        if (currentGameMode.GameMode == GameMode.VirusSelection) selectableSprite.material = availableToSelect_Off;
        else if (currentGameMode.GameMode == GameMode.PlayerTour)
        {
            selectableSprite.material = availableToSelect_On;
            GlowEffectSelectMaterial();
        }
    }

    private void GlowEffectSelectMaterial()
    {
        StartCoroutine(GlowEffect());
    }

    private IEnumerator GlowEffect()
    {
        availableTOSelect_intensity = 30;
        while (availableTOSelect_intensity > 10f)
        {
            availableTOSelect_intensity -= 0.3f;
            availableToSelect_On.SetVector("_EmissionColor", availableToSelect_On.color * availableTOSelect_intensity);
            yield return new WaitForSeconds(0.01f);
        }

    }

    public void CheckForEdge()
    {
        for (int i = 0; i < 8; i++) 
            Physics.Raycast(transform.position, dir[i], out raycastHit[i], 0.72f, layermask);

        FindBorder();
        SetBorders();
    }


    public void SelectableChange()
    {
        SelectableImage.SetActive(Selectable);
    }

    public void Select()
    {
        if (Selectable) {
            _intensity = 7;
            selectMaterial.SetVector("_EmissionColor", _emissionActiveColorValue * _intensity);
        }
        else
        {
            _intensity = 1.5f;
            selectMaterial.SetVector("_EmissionColor", _emissionPasiveColorValue * _intensity);
        }

        MouseOverImage.SetActive(true);
    }

    public void UnSelect()
    {
        MouseOverImage.SetActive(false);
    }
    

    public void CalculateIsSelectable(float charPosX, float charPosZ)
    {
        if (playerRange.Range < 10) return;

        int x = Mathf.RoundToInt(charPosX);
        int z = Mathf.RoundToInt(charPosZ);

        PathNode startNode = pathFinding.GetGridNode(x, z);
        PathNode endNode = pathFinding.GetGridNode((int)transform.position.x, (int)transform.position.z);

        int distanceCost = pathFinding.CalculateDistnceCost(startNode, endNode);

        if (distanceCost <= playerRange.Range &&
            pathFinding.CalculatePathCost(pathFinding.FindPath(startNode, endNode)) <= playerRange.Range)
            Selectable = true;
    }

    public float DistanceCostToPlayer(float x, float z)
    {
        Vector3 playerPos = new Vector3 (x, transform.position.y, z);
        return Vector3.Distance(transform.position, playerPos) * 9;
    }

    public void ResetSelectable()
    {
        Selectable = false;
        SelectableChange();
    }

    private void LateUpdate()
    {
        if (currentGameMode.GameMode == GameMode.VirusSelection) UnSelect();
        if (currentGameMode.GameMode == GameMode.EnemyTour)
        {
            Selectable = false;
            SelectableChange();
        }
    }

    private void OnTriggerEnter(Collider other)
    {
        if (other.gameObject.layer == LayerMask.NameToLayer("Objects"))
        {
            gameObject.layer = LayerMask.NameToLayer("Default");
        }

        if (other.gameObject.layer == LayerMask.NameToLayer("DoorController"))
        {
            DoorController = true;
            doorsController = other.gameObject.GetComponent<IDoorsHandler>();
        }
    }
    private void OnTriggerStay(Collider other)
    {
        if (other.gameObject.layer == LayerMask.NameToLayer("Objects"))
        {
            gameObject.layer = LayerMask.NameToLayer("Default");
        }
    }
    private void OnTriggerExit(Collider other)
    {
        if (other.gameObject.layer == LayerMask.NameToLayer("Objects"))
        {
            gameObject.layer = LayerMask.NameToLayer("Walkable");
        }
    }

    public void DoorControllerClicked()
    {
        doorsController.Selected = true;
    }

    private void ResetDoorController()
    {
       if (doorsController != null) doorsController.Selected = false;
    }


    #region Borders
    private void FindBorder()
    {
        if (CollisionInDirection(Direction.Up))
        {
            if (CollisionInDirection(Direction.Down))
            {
                if (CollisionInDirection(Direction.Right)) border = Border.UpDownRight;
                else if (CollisionInDirection(Direction.Left)) border = Border.UpDownLeft;
                else border = Border.UpDown;
            }
            else if (CollisionInDirection(Direction.Right))
            {
                if (CollisionInDirection(Direction.Left)) border = Border.UpRightLeft;
                else if (CollisionInDirection(Direction.DownLeft)) border = Border.CornerDownLeft_BorderRightBorderUp;
                else border = Border.UpRight;
            }
            else if (CollisionInDirection(Direction.Left))
            {
                if (CollisionInDirection(Direction.DownRight)) border = Border.CornerDownRight_BorderLeftBorderUp;
                else border = Border.UpLeft;
            }
            else if (CollisionInDirection(Direction.DownRight))
            {
                if (CollisionInDirection(Direction.DownLeft)) border = Border.Up_TwoCorners;
                else border = Border.Up_CornererRight;
            }
            else if (CollisionInDirection(Direction.DownLeft)) border = Border.Up_CornerLeft;
            else border = Border.Up;
        }
        else if (CollisionInDirection(Direction.Down))
        {
            if (CollisionInDirection(Direction.Right))
            {
                if (CollisionInDirection(Direction.Left)) border = Border.DownRightLeft;
                else if (CollisionInDirection(Direction.UpLeft)) border = Border.CornerUpLeft_BorderRightBorderDown;
                else border = Border.DownRight;
            }
            else if (CollisionInDirection(Direction.Left))
            {
                if (CollisionInDirection(Direction.UpRight)) border = Border.CornerUpRight_BorderLeftBorderDown;
                else border = Border.DownLeft;
            }
            else if (CollisionInDirection(Direction.UpRight))
            {
                if (CollisionInDirection(Direction.UpLeft)) border = Border.Down_TwoCorners;
                else border = Border.Down_CornerRight;
            }
            else if (CollisionInDirection(Direction.UpLeft)) border = Border.Down_CornerLeft;
            else border = Border.Down;
        }
        else if (CollisionInDirection(Direction.Right))
        {
            if (CollisionInDirection(Direction.Left)) border = Border.RightLeft;
            else if (CollisionInDirection(Direction.UpLeft))
            {
                if (CollisionInDirection(Direction.DownLeft)) border = Border.Right_TwoCorners;
                else border = Border.Right_CornerUp;
            }
            else if (CollisionInDirection(Direction.DownLeft)) border = Border.Right_CornerDown;
            else border = Border.Right;
        }
        else if (CollisionInDirection(Direction.Left))
        {
            if (CollisionInDirection(Direction.UpRight))
            {
                if (CollisionInDirection(Direction.DownRight)) border = Border.Left_TwoCornsers;
                else border = Border.Left_CornerUp;
            }
            else if (CollisionInDirection(Direction.DownRight)) border = Border.Left_CornerDown;
            else border = Border.Left;
        }
        else if (CollisionInDirection(Direction.UpRight) &&
            CollisionInDirection(Direction.DownRight) &&
            CollisionInDirection(Direction.UpLeft) &&
            CollisionInDirection(Direction.DownLeft))
                border = Border.FourCorners;

        //corners

        else if (CollisionInDirection(Direction.UpRight))
        {
            if (CollisionInDirection(Direction.DownRight))
            {
                if (CollisionInDirection(Direction.DownLeft)) border = Border.CornerUpRightDownRightDownLeft;
                else if (CollisionInDirection(Direction.UpLeft)) border = Border.CornerUpRightUpLeftDownRight;
                else border = Border.CornerRightUpDown;
            }
            else if (CollisionInDirection(Direction.UpLeft))
            {
                if (CollisionInDirection(Direction.DownLeft)) border = Border.CornerUpRightUpLeftDownLeft;
                else border = Border.CornerUpRightLeft;
            }
            else border = Border.CornerUpRight;
        }
        else if (CollisionInDirection(Direction.UpLeft))
        {
            if (CollisionInDirection(Direction.DownLeft))
            {
                if (CollisionInDirection(Direction.DownRight)) border = Border.CornerUpLeftDownLeftDownRight;
                else border = Border.CornerLeftUpDown;
            }
            else border = Border.CornerUpLeft;
        }
        else if (CollisionInDirection(Direction.DownRight))
        {
            if (CollisionInDirection(Direction.DownLeft)) border = Border.CornerDownRightLeft;
            else border = Border.CornerDownRight;
        }
        else if (CollisionInDirection(Direction.DownLeft)) border = Border.CornerDownLeft;
        else border = Border.None;

    }
    private bool CollisionInDirection(Direction dir)
    {
        return (raycastHit[(int)dir].collider != null && !raycastHit[(int)dir].collider.GetComponent<FloorTile>().Selectable) || raycastHit[(int)dir].collider == null;
    }
    private void SetBorders()
    {
        selectableSprite.sprite = borderSprite[(int)border];

    }

    #endregion
}
