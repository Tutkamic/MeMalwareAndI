using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;

public class CharacterMoveRange : MonoBehaviour
{
    PathFinding pathFinding;
    private int currentRange;
    private int currentVirusIndex = 0;

    private List<FloorTile> floortiles;

    List<FloorTile> tilesInRange = new List<FloorTile>();

    private void OnEnable()
    {
        MovementCharacter.StopMoving += MoveStop;
        MovementCharacter.StartMoving += ResetSelectableTiles;
        CharacterStateManager.VirsuActivated += SetRange;
    }
    private void OnDisable()
    {
        MovementCharacter.StopMoving -= MoveStop;
        MovementCharacter.StartMoving -= ResetSelectableTiles;
        CharacterStateManager.VirsuActivated -= SetRange;
    }


    private void Awake()
    {
        pathFinding = FindObjectOfType<PathFinding>();
        floortiles = FindObjectsOfType<FloorTile>().ToList();
    }

    private void Start()
    {
        SetRange(0);
        MoveStop();
    }

    private void MoveStop()
    {
        if (currentRange < 10) return;
        CalculateSelectableTiles();
    }

    private void CalculateSelectableTiles()
    {
        int x = Mathf.RoundToInt(transform.position.x);
        int z = Mathf.RoundToInt(transform.position.z);
        tilesInRange = pathFinding.TilesInRange(x, z, currentRange);
        foreach (FloorTile tile in tilesInRange) tile.SelectableChange(true);
    }

    private void ResetSelectableTiles()
    {
        foreach (FloorTile tile in floortiles) tile.SelectableChange(false);
    }

    public void RangeDecrease(int x)
    {
        currentRange -= x;
    }

    private void SetRange(int virusIndex)
    {
        ResetSelectableTiles();

        switch (virusIndex)
        {
            case 0: 
                currentRange = 120;
                break;
            case 1:
                currentRange = 100;
                break;
            case 2:
                currentRange = 70;
                break;
        }
        CalculateSelectableTiles();
    }
}
