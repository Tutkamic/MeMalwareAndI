using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class CharacterStateManager : MonoBehaviour
{
    public static event Action VirsuActivated;

    public CharacterVirus1State virus1State = new CharacterVirus1State();
    public CharacterVirus2State virus2State = new CharacterVirus2State();
    public CharacterVirus3State virus3State = new CharacterVirus3State();

    [SerializeField] BoolVariableSO canShowFoV;
    [SerializeField] BoolVariableSO isFloorCalculationFinish;
    [SerializeField] int[] virusMoveRange;
    [SerializeField] PlayerRangeSO playerRange;
    [SerializeField] GameModeSO currentGameMode;

    CharacterBaseState currentState;

    private Dictionary<int, CharacterBaseState> virusesStates = new Dictionary<int, CharacterBaseState>();


    private void OnEnable()
    {
        GameModeHandler.StartMode += ActivateDefaultVirus;
    }
    private void OnDisable()
    {
        GameModeHandler.StartMode -= ActivateDefaultVirus;
    }
    void Start()
    {
        isFloorCalculationFinish.SetValue(false);
        currentState = virus1State;
        virusesStates.Add(1, virus1State);
        virusesStates.Add(2, virus2State);
        virusesStates.Add(3, virus3State);
    }


    void Update()
    {
        if (currentGameMode.GameMode == GameMode.PlayerTour) currentState.UpdateState(this);
    }


    public void SetMalwareState(int virusNum)
    {
        SwitchState(virusesStates[virusNum]);
    }

    public void SwitchState(CharacterBaseState state)
    {
        if (currentState == state) return;

        currentState = state;
        state.EnterState(this);
    }

    public void VirusActivate(int virusIndex)
    {
        playerRange.SetRange(virusMoveRange[virusIndex]);
        VirsuActivated?.Invoke();
    }

    public void ActivateDefaultVirus(GameMode mode)
    {
        if (mode == GameMode.VirusSelection)
        {
            currentState = virusesStates[1];
            VirusActivate(0);
        }
    }
    public void SetCanShowFoV(bool show)
    {
        canShowFoV.SetValue(show);
    }
}
