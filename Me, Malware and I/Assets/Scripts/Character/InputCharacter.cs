using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class InputCharacter : MonoBehaviour
{
    public static event Action<int, int, int, int> DrawLine;
    public static event Action OnFLoorClicked;

    [SerializeField] GameModeSO currentGameMode;



    private IWalkable previourFloor;
    ICharacterMove characterMove;
    MovementCharacter movementCharacter;
    bool canMove = false;
    int lastTileX;
    int lastTileZ;

    private void Awake()
    {
        characterMove = GetComponent<ICharacterMove>();
        movementCharacter = GetComponent<MovementCharacter>();
    }

    void Update()
    {
        if (currentGameMode.GameMode == GameMode.VirusSelection || 
            currentGameMode.GameMode == GameMode.PlayerTour) OnMouseOverFLoor();

        if (currentGameMode.GameMode != GameMode.PlayerTour) return;


        if (Input.GetMouseButtonDown(0))
        {
            characterMove.CancelMovement();
            MousePositionInput();
        }
    }
    private void LateUpdate()
    {
        OnPlayerBehindTransparentObject();
    }

    private void OnMouseOverFLoor()
    {
        RaycastHit[] hits;
        Ray ray = Camera.main.ScreenPointToRay(Input.mousePosition);
        hits = Physics.RaycastAll(ray);

        for (int i = 0; i < hits.Length; i++)
        {
            RaycastHit hit = hits[i];
            if (hit.collider != null)
                if(hit.collider.TryGetComponent<IWalkable>(out IWalkable floor))
                {
                    if(previourFloor != null)
                        previourFloor.UnSelect();
                    floor.Select();
                    previourFloor = floor;
                }
        }
    }


    private void MousePositionInput()
    {
        RaycastHit[] hits;
        Ray ray = Camera.main.ScreenPointToRay(Input.mousePosition);
        hits = Physics.RaycastAll(ray);

        for (int i = 0; i < hits.Length; i++)
        {
            RaycastHit hit = hits[i];
            if (hit.collider != null)
                if(hit.collider.TryGetComponent<IWalkable>(out IWalkable floor))
                {
                    OnFLoorClicked?.Invoke();

                    if (floor.DoorController)
                    {
                        floor.DoorControllerClicked();
                        movementCharacter.CheckForController();
                    }



                    int w = (int)hit.transform.gameObject.transform.position.x;
                    int h = (int)hit.transform.gameObject.transform.position.z;
                    int x = Mathf.RoundToInt(transform.position.x);
                    int z = Mathf.RoundToInt(transform.position.z);

                    if ((w == x && h == z) || !floor.Selectable) return;

                    if (canMove && lastTileX == w && lastTileZ == h)
                    {
                        canMove = false;
                        characterMove.Move(w, h, x, z);
                    }

                    else
                    {
                        canMove = true;
                        DrawLine?.Invoke(w, h, x, z);
                    }

                    lastTileX = w;
                    lastTileZ = h;
                }
        }
    }

    private void OnPlayerBehindTransparentObject()
    {
        RaycastHit[] hits;
        Vector3 screenPos = Camera.main.WorldToScreenPoint(transform.position);
        Ray ray = Camera.main.ScreenPointToRay(screenPos);
        hits = Physics.RaycastAll(ray);

        for (int i = 0; i < hits.Length; i++)
        {
            RaycastHit hit = hits[i];
            if (hit.collider != null)
                if (hit.collider.TryGetComponent<ITransparencyObjectHandler>(out ITransparencyObjectHandler obj))
                {
                    obj.ChangeTransparency(true);
                }
        }
    }
}
